{% extends "base.html" %}

{% block content %}
  <h1>Devices</h1>


  {% block search_form %}
    {% include "includes/search_form.html" %}
  {% endblock %}


<form method="get">

<form method="get" action="{% url 'device:device-list' %}">
    <label for="status">Filter by Status:</label>
    <select name="status" id="status" multiple>
<!--        <option value="">All</option>-->
        {% for status in device_status_list %}
            <option value="{{ status.device_status__name }}" {% if status.device_status__name in selected_statuses %}selected{% endif %}>{{ status.device_status__name }}</option>
        {% endfor %}
    </select>

    <label for="department">Filter by Department:</label>
    <select name="department" id="department" multiple>
<!--        <option value="">All</option>-->
        {% for department in department_list %}
            {% with department_name=department.department__site__name|add:" "|add:department.department__name %}
            <option value="{{ department_name }}" {% if department_name in selected_departments %}selected{% endif %}>
                {{ department_name }}
            </option>
            {% endwith %}
        {% endfor %}
    </select>

    <label for="site">Filter by Site:</label>
    <select name="site" id="site" multiple>
<!--        <option value="">All</option>-->
        {% for site in device_site_list %}
            <option value="{{ site.department__site__name }}" {% if site.department__site__name in selected_sites %}selected{% endif %}>{{ site.department__site__name }}</option>
        {% endfor %}
    </select>


    <input type="hidden" name="device_type" value="{{ request.GET.device_type }}">

    <button type="submit">Apply Filter</button>
  </form>
  <a class="button button-gray" style="float: right;" href="{% url 'device:device-create' %}">Create</a>
  {% if device_list %}
  <p>Total devices: {{ device_list.count }}</p>
  <div class="table-responsive">
    <table class="table">
      <thead class="thead-dark">
        <tr>
          <th>Name</th>
          <th>Device Type</th>
          <th>Serial Number</th>
          <th>Status
            

          </th>
          <th>IP</th>
          <th>Ports</th>
          <th>Department</th>
          <th>Model</th>
          <th>Update</th>
          <th>Delete</th>
        </tr>
      </thead>
      <tbody>
        {% for device in device_list %}
        <tr>
          <td><a class="text-primary" href="{% url 'device:device-detail' pk=device.id %}">{{ device.name }}</a></td>
          <td>{{ device.device_type.name }}</td>
          <td>{{ device.device_serial_number }}</td>
          <td>{{ device.device_status.name }}</td>
          <td>{{ device.device_ip.ip }}</td>
          <td>
            {% if device.device_ports %}
            {% for port in device.device_ports.all %}
              {{ port.name }}
            {% endfor %}
            {% else %}
              <p>-</p>
            {% endif %}
          </td>
          <td>{{ device.department }}</td>
          <td>{{ device.device_model }}</td>
           <td><a class="text-info" href="{% url 'device:device-update' pk=device.id %}">Update</a></td>
           <td><a class="text-danger" href="{% url 'device:device-delete' pk=device.id %}">Delete</a></td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
    <p>There are no devices in Device!</p>
  {% endif %}



{% endblock %}

<script>
document.addEventListener("DOMContentLoaded", function () {
    const select = document.getElementById("site");

    select.addEventListener("change", function () {
        const selectedValues = Array.from(select.selectedOptions, option => option.value);
        const searchParams = new URLSearchParams(window.location.search);

        if (selectedValues.length > 0) {
            searchParams.set("site", selectedValues.join(","));
        } else {
            searchParams.delete("site");
        }

        const newUrl = window.location.pathname + "?" + searchParams.toString();
        window.history.replaceState({}, "", newUrl);
    });

    // Restore selected values on page load
    const urlParams = new URLSearchParams(window.location.search);
    const selectedSites = urlParams.get("site");
    if (selectedSites) {
        const sitesArray = selectedSites.split(",");
        sitesArray.forEach(site => {
            const option = select.querySelector(`option[value="${site}"]`);
            if (option) {
                option.selected = true;
            }
        });
    }
});
</script>



